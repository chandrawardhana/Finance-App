@page "/verifications"
@using Accounting.Client
@implements IDisposable
@inject NavigationManager NavigationManager
@inject IVerificationsClient VerificationsClient
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Verifications</PageTitle>

<MudText Typo="Typo.h3" Class="mt-4 mb-2">Verifications</MudText>

<MudButton StartIcon="@Icons.Material.Outlined.Add" Link="/verifications/new" Variant="Variant.Filled" Color="Color.Primary" Class="mb-2">
    Create verification
</MudButton>

<MudButton StartIcon="@Icons.Material.Outlined.Add" Link="/verifications/sale" Variant="Variant.Filled" Color="Color.Primary" Class="mb-2">
    Register sale
</MudButton>

<MudTable Items="verifications" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@(verifications is null)" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Verification No</MudTh>
        <MudTh>Date</MudTh>
        <MudTh>Description</MudTh>
        <MudTh>Debit</MudTh>
        <MudTh>Credit</MudTh>
    </HeaderContent>
    <RowTemplate Context="verification">
        <MudTd DataLabel="Verification No">
            <MudLink Href="@($"/ledger?verificationNo={verification.VerificationNo}")">@verification.VerificationNo</MudLink>
        </MudTd>
        <MudTd DataLabel="Date">@verification.Date.ToString("g")</MudTd>
        <MudTd DataLabel="Description">@verification.Description</MudTd>
        <MudTd DataLabel="Debit">@verification.Debit.ToString("c")</MudTd>
        <MudTd DataLabel="Credit">@verification.Credit.ToString("c")</MudTd>
    </RowTemplate>
</MudTable>


@code
{
    IEnumerable<Verification>? verifications = null;

    [SupplyParameterFromQuery]
    [Parameter]
    public string? VerificationNo { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadData();

        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs ea)
    {
        await LoadData();

        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task LoadData()
    {
        verifications = await VerificationsClient.GetVerificationsAsync();
    }

    private async Task OpenNewVerificationDialog()
    {
        /*
        var dialogReference = DialogService.Show<NewVerificationDialog>("New Verification");

        var result = await dialogReference.Result;

        if (result.Cancelled) return;

        Snackbar.Add("The reactor is running at optimum temperature", Severity.Success);
        */

        NavigationManager.NavigateTo("/verifications/new");
    }

    class VerificationViewModel
    {
        public string VerificationNo { get; set; } = null!;

        public DateTime Date { get; set; }

        public string Description { get; set; } = null!;

        public decimal Debit { get; set; }

        public decimal Credit { get; set; }
    }
}