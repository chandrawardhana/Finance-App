@page "/ledger"
@using Accounting.Client
@inject NavigationManager NavigationManager
@inject IEntriesClient EntriesClient

<PageTitle>@title</PageTitle>

<MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true" Class="mt-4 mb-8">@title</MudText>

<MudTable @ref="table" ServerData="@(new Func<TableState, Task<TableData<Entry>>>(ServerReload))" Elevation="0" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@loading" LoadingProgressColor="Color.Info">
    <HeaderContent>
        <MudTh>Verification No</MudTh>
        <MudTh colspan="2">Account</MudTh>
        <MudTh>Debit</MudTh>
        <MudTh>Credit</MudTh>
    </HeaderContent>
    <RowTemplate Context="entry">
        <MudTd DataLabel="Verification No">
            <MudLink Href="@($"/ledger?verificationNo={entry.Verification.VerificationNo}")">@entry.Verification.VerificationNo</MudLink>
        </MudTd>
        <MudTd DataLabel="Account No">@entry.Account.AccountNo</MudTd>
        <MudTd DataLabel="Account Name">@entry.Account.Name</MudTd>
        <MudTd DataLabel="Debit">@entry.Debit?.ToString("c")</MudTd>
        <MudTd DataLabel="Credit">@entry.Credit?.ToString("c")</MudTd>
    </RowTemplate>
    <LoadingContent>
        <MudText>Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>

@code
{
    MudTable<Entry>? table = null!;

    string title = "Ledger";
    bool loading = false;

    [SupplyParameterFromQuery]
    [Parameter]
    public string? VerificationNo { get; set; }

    protected override void OnInitialized()
    {
        title = $"Ledger";

        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs ea)
    {
        if (table is not null)
        {
            await table.ReloadServerData();
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    private async Task<TableData<Entry>> ServerReload(TableState state)
    {
        loading = true;

        try
        {
            var result = await EntriesClient.GetEntriesAsync(null, VerificationNo, state.Page, state.PageSize);

            if (VerificationNo is not null)
            {
                title = $"{VerificationNo} - {result.Entries.First().Verification.Description}";
            }
            else
            {
                title = $"Ledger";
            }

            StateHasChanged();

            return new TableData<Entry>() { TotalItems = result.TotalItems, Items = result.Entries };
        }
        finally
        {
            loading = false;
        }
    }
}